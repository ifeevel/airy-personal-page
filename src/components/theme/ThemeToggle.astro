---
/**
 * ThemeToggle.astro
 * 主题切换按钮组件
 *
 * 样式：
 * - 内联样式
 */
---

<div class="theme-toggle-container">
    <button id="theme-toggle" aria-label="切换主题">
        <svg
            class="sun-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg
            class="moon-icon"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>
</div>

<style>
    .theme-toggle-container {
        position: fixed;
        top: 1.25rem;
        right: 1.25rem;
        z-index: 1000;
    }

    /* 移动端稍微往下挪一点，避开可能的刘海屏或状态栏 */
    @media (max-width: 48rem) {
        .theme-toggle-container {
            top: 0.9375rem;
            right: 0.9375rem;
        }
    }

    #theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        color: var(--text-primary);
        /* 为图标绝对定位提供容器 */
        position: relative;
        overflow: hidden;
        border-radius: 50%;
        transition: background-color 0.3s;
        /* 按钮独立于全局 View Transition 淡化，避免图标动画重影和跳变 */
        view-transition-name: theme-toggle-button;
    }

    #theme-toggle:hover {
        color: var(--link-hover);
        background-color: var(--bg-footer);
    }

    #theme-toggle:active {
        /* 点击时的物理反馈 */
        transform: scale(0.9);
    }

    .sun-icon,
    .moon-icon {
        position: absolute;
        transform-origin: center;
        will-change: transform, opacity;
    }

    /* --- 核心动画逻辑 --- */

    /* 默认状态（亮色模式） */
    .sun-icon {
        opacity: 1;
        transform: scale(1) rotate(0deg);
    }
    .moon-icon {
        opacity: 0;
        transform: scale(0) rotate(-90deg);
    }

    /* 初始加载时的暗色模式状态 */
    :global(.dark) .sun-icon {
        opacity: 0;
        transform: scale(0) rotate(90deg);
    }
    :global(.dark) .moon-icon {
        opacity: 1;
        transform: scale(1) rotate(0deg);
    }

    /* 仅在按钮被点击后添加动画类 */
    #theme-toggle.switching .sun-icon,
    #theme-toggle.switching .moon-icon {
        /* 动画执行完保持最终状态 */
        animation-fill-mode: forwards;
        animation-duration: 0.3s;
        /* 弹性缓动 */
        animation-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* 切换到暗色模式时的动画 */
    :global(.dark) #theme-toggle.switching .sun-icon {
        animation-name: icon-exit;
    }
    :global(.dark) #theme-toggle.switching .moon-icon {
        animation-name: icon-enter;
    }

    /* 切换回亮色模式时的动画 */
    :global(html:not(.dark)) #theme-toggle.switching .sun-icon {
        animation-name: icon-enter;
    }
    :global(html:not(.dark)) #theme-toggle.switching .moon-icon {
        animation-name: icon-exit;
    }

    /* --- 统一的进入与退出动画 --- */

    @keyframes icon-exit {
        0% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: scale(0) rotate(90deg);
            opacity: 0;
        }
    }

    @keyframes icon-enter {
        0% {
            transform: scale(0) rotate(-90deg);
            opacity: 0;
        }
        100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
    }
</style>

<script>
    // 主题切换处理函数
    const handleToggleClick = () => {
        const themeToggleBtn = document.getElementById("theme-toggle");

        // 状态逻辑封装
        const toggleThemeLogic = () => {
            // 添加动画标记类(无需移除，依靠 CSS 的 animation-name 切换重置动画)
            if (themeToggleBtn) themeToggleBtn.classList.add("switching");

            // 更新 localStorage
            const isDark = document.documentElement.classList.contains("dark");
            const nextTheme = isDark ? "light" : "dark";
            try { localStorage.setItem("theme", nextTheme); } catch (e) {}

            // 执行主题应用逻辑(兼回退)
            // @ts-ignore
            typeof applyTheme === "function" ? applyTheme() : document.documentElement.classList.toggle("dark");
        };

        // 使用 View Transitions API 执行极简交叉淡化
        if (!document.startViewTransition) {
            toggleThemeLogic();
            return;
        }

        document.startViewTransition(() => { toggleThemeLogic(); });
    };

    // 绑定主题切换按钮事件
    function setupThemeToggle() {
        const themeToggleBtn = document.getElementById("theme-toggle");
        if (themeToggleBtn) {
            // 移除旧的事件监听器（如果存在）
            themeToggleBtn.removeEventListener("click", handleToggleClick);
            // 添加新的事件监听器
            themeToggleBtn.addEventListener("click", handleToggleClick);
        }
    }

    // 初始加载时绑定
    setupThemeToggle();

    // View Transitions 支持 (如后续启用 ClientRouter)
    // document.addEventListener("astro:page-load", setupThemeToggle);
</script>
